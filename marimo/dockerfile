FROM ghcr.io/marimo-team/marimo:latest

# Set environment variables
ENV PYTHONUNBUFFERED=1 \
    PYTHONIOENCODING=UTF-8 \
    MARIMO_USER_CONFIG_PATH=/app/state

# Set working directory
WORKDIR /app

# Create state directory
RUN mkdir -p /app/state

# Copy requirements first to leverage Docker layer caching
COPY requirements.txt .

# Install dependencies
RUN pip install --no-cache-dir -r requirements.txt

# Copy the application files
COPY main.py .
COPY quixlake_sdk-0.1.0-py3-none-any.whl .

# Install local wheel if needed
RUN pip install --no-cache-dir quixlake_sdk-0.1.0-py3-none-any.whl

# Expose port
EXPOSE 8080

# Create default marimo config with dark theme
RUN mkdir -p /app/state && \
    echo '{"completion": {"activate_on_typing": true, "copilot": false}, "display": {"theme": "dark", "code_editor_font_size": 14}, "formatting": {"line_length": 79}, "runtime": {"auto_instantiate": true}, "save": {"autosave": "after_delay", "autosave_delay": 1000, "format_on_save": false}, "keymap": {"preset": "default"}}' > /app/state/marimo.toml

# Run marimo in production mode
CMD ["marimo", "run", "main.py", "--host", "0.0.0.0", "-p", "8080"]